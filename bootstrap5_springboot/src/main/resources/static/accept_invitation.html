<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chấp nhận lời mời tham gia nhóm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="card-title">Lời mời tham gia nhóm</h3>
                        <div id="message" class="my-4">
                            <p>Đang xử lý lời mời...</p>
                        </div>
                        <button id="btnAccept" class="btn btn-primary btn-lg" style="display: none;">
                            Chấp nhận tham gia
                        </button>
                        <div id="successMessage" class="alert alert-success" style="display: none;">
                            <h4>Thành công!</h4>
                            <p>Bạn đã tham gia nhóm thành công.</p>
                            <a href="projects_groups.html" class="btn btn-success">Đến trang nhóm</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
            document.getElementById('message').innerHTML = `
                <div class="alert alert-danger">
                    <h4>Lỗi!</h4>
                    <p>Token không hợp lệ hoặc đã hết hạn.</p>
                </div>
            `;
        } else {
            // Hiển thị nút chấp nhận
            document.getElementById('btnAccept').style.display = 'block';
            document.getElementById('message').innerHTML = `
                <p>Bạn đã được mời tham gia một nhóm làm việc.</p>
                <p>Hãy chấp nhận để bắt đầu cộng tác!</p>
            `;

            document.getElementById('btnAccept').addEventListener('click', function() {
                const user = JSON.parse(localStorage.getItem('user'));
                const userToken = localStorage.getItem('token');

                if (!user || !userToken) {
                    alert('Vui lòng đăng nhập để chấp nhận lời mời');
                    window.location.href = 'login.html';
                    return;
                }

                fetch('http://localhost:8080/invitations/accept', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({ token: token })
                })
                .then(response => {
					if (data.user) {
					    localStorage.setItem('user', JSON.stringify(data.user));
					} else {
					    // Fallback nếu server không trả về user
					    const user = JSON.parse(localStorage.getItem('user'));
					    user.accountType = "TEAM";
					    user.role = "MEMBER";
					    user.organization = true;
					    localStorage.setItem('user', JSON.stringify(user));
					}
                })
                .catch(error => {
                    document.getElementById('message').innerHTML = `
                        <div class="alert alert-danger">
                            <h4>Lỗi!</h4>
                            <p>Không thể chấp nhận lời mời: ${error.message}</p>
                        </div>
                    `;
                });
            });
        }
    </script>
</body>
</html>