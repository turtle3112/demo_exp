<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu√™n M·∫≠t Kh·∫©u - Task Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            position: relative;
            overflow: hidden;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #333;
            font-size: 28px;
            font-weight: 600;
        }

        .logo p {
            color: #666;
            margin-top: 8px;
            font-size: 14px;
        }

        .demo-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            border: 2px solid #e9ecef;
        }

        .step.active .step-number {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .step.completed .step-number {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .step-text {
            font-size: 12px;
            color: #6c757d;
            text-align: center;
        }

        .step.active .step-text {
            color: #007bff;
            font-weight: 500;
        }

        .step-divider {
            width: 80px;
            height: 2px;
            background: #e9ecef;
            margin: 20px 10px 0;
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .otp-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .otp-input {
            flex: 1;
            width: 20px;
            height: 44px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            transition: all 0.3s ease;
            padding: 0;
        }

        .otp-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            transform: scale(1.05);
        }

        .otp-input.filled {
            border-color: #28a745;
            background-color: #f8fff9;
            box-shadow: 0 2px 5px rgba(40, 167, 69, 0.2);
        }

        .timer {
            text-align: center;
            margin: 15px 0;
            font-size: 14px;
            color: #6c757d;
        }

        .timer.expired {
            color: #dc3545;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .message.demo {
            background: #e7f3ff;
            color: #004085;
            border: 1px solid #b8daff;
        }

        .resend-otp {
            text-align: center;
            margin: 20px 0;
        }

        .resend-link {
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
        }

        .resend-link:hover {
            text-decoration: underline;
        }

        .resend-link.disabled {
            color: #6c757d;
            cursor: not-allowed;
            text-decoration: none;
        }

        .resend-link.loading {
            opacity: 0.6;
            cursor: wait;
        }

        .back-link {
            text-align: center;
            margin-top: 25px;
        }

        .back-link a {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        .password-strength {
            margin-top: 8px;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            width: 0%;
            transition: all 0.3s ease;
        }

        .password-strength.weak .password-strength-bar {
            background: #dc3545;
            width: 33%;
        }

        .password-strength.medium .password-strength-bar {
            background: #ffc107;
            width: 66%;
        }

        .password-strength.strong .password-strength-bar {
            background: #28a745;
            width: 100%;
        }

        .password-requirements {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .otp-display {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin: 15px 0;
        }

        .otp-display code {
            font-size: 24px;
            font-weight: bold;
            color: #dc3545;
            letter-spacing: 5px;
        }

        .quick-test-buttons {
            text-align: center;
            margin-top: 15px;
        }

        .quick-test-buttons button {
            padding: 8px 12px;
            margin: 0 5px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .quick-test-buttons button:hover {
            background: #545b62;
        }

        .api-status {
            text-align: center;
            margin: 10px 0;
            font-size: 12px;
            padding: 8px;
            border-radius: 4px;
        }

        .api-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .api-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 480px) {
            .container {
                padding: 30px 20px;
            }
            
            .otp-input-group {
                gap: 8px;
            }
            
            .otp-input {
                height: 40px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>üîê Qu√™n M·∫≠t Kh·∫©u</h1>
            <p>K·∫øt n·ªëi Backend - OTP s·∫Ω hi·ªán trong Console Server</p>
        </div>

        <div class="demo-notice">
            üöÄ <strong>CH·∫æ ƒê·ªò BACKEND TH·∫¨T</strong> - OTP s·∫Ω ƒë∆∞·ª£c in ra console c·ªßa Spring Boot
        </div>

        <!-- API Connection Status -->
        <div id="apiStatus" class="api-status" style="display: none;">
            üîç ƒêang ki·ªÉm tra k·∫øt n·ªëi server...
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-text">Nh·∫≠p Email</div>
            </div>
            <div class="step-divider"></div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-text">Nh·∫≠p OTP</div>
            </div>
            <div class="step-divider"></div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-text">M·∫≠t Kh·∫©u M·ªõi</div>
            </div>
        </div>

        <!-- Messages Container -->
        <div id="messageContainer"></div>

        <!-- Step 1: Enter Email -->
        <div class="form-step active" id="step1Form">
            <div class="message demo">
                üí° <strong>L∆∞u √Ω:</strong> Nh·∫≠p email c·ªßa user c√≥ trong database
            </div>
            
            <div class="form-group">
                <label for="email">Email c·ªßa b·∫°n</label>
                <input type="email" id="email" class="form-control" placeholder="example@test.com" required>
            </div>
            <button type="button" class="btn btn-primary" onclick="sendOTP()" id="sendOtpBtn">G·ª≠i M√£ OTP</button>
            
            <div class="quick-test-buttons">
                <button onclick="document.getElementById('email').value = 'test@example.com'">Test Email</button>
                <button onclick="document.getElementById('email').value = 'admin@example.com'">Admin Email</button>
            </div>
            
            <div class="back-link">
                <a href="login.html">‚Üê Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
            </div>
        </div>

        <!-- Step 2: Enter OTP -->
        <div class="form-step" id="step2Form">
            <div class="message info">
                üìß M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn: <strong id="emailDisplay"></strong>
            </div>
            
            <!-- OTP Display for Backend -->
            <div class="otp-display">
                <div>üîë <strong>KI·ªÇM TRA CONSOLE BACKEND:</strong></div>
                <div style="font-size: 14px; color: #666; margin-top: 8px;">
                    M√£ OTP s·∫Ω hi·ªán trong console Spring Boot<br>
                    (N∆°i b·∫°n ch·∫°y ·ª©ng d·ª•ng Java)
                </div>
            </div>
            
            <div class="form-group">
                <label>M√£ OTP (6 ch·ªØ s·ªë)</label>
                <div class="otp-input-group gap-6">
                    <input type="text" class="otp-input" maxlength="1" data-index="0" oninput="handleOtpInput(this)" onkeydown="handleOtpKeydown(this, event)">
                    <input type="text" class="otp-input" maxlength="1" data-index="1" oninput="handleOtpInput(this)" onkeydown="handleOtpKeydown(this, event)">
                    <input type="text" class="otp-input" maxlength="1" data-index="2" oninput="handleOtpInput(this)" onkeydown="handleOtpKeydown(this, event)">
                    <input type="text" class="otp-input" maxlength="1" data-index="3" oninput="handleOtpInput(this)" onkeydown="handleOtpKeydown(this, event)">
                    <input type="text" class="otp-input" maxlength="1" data-index="4" oninput="handleOtpInput(this)" onkeydown="handleOtpKeydown(this, event)">
                    <input type="text" class="otp-input" maxlength="1" data-index="5" oninput="handleOtpInput(this)" onkeydown="handleOtpKeydown(this, event)">
                </div>
            </div>

            <div class="timer" id="otpTimer">
                ‚è∞ M√£ OTP c√≥ hi·ªáu l·ª±c trong: <span id="countdown">05:00</span>
            </div>

            <div class="resend-otp">
                <a href="javascript:void(0)" class="resend-link disabled" id="resendLink" onclick="resendOTP()">G·ª≠i l·∫°i m√£ OTP</a>
            </div>

            <div class="quick-test-buttons">
                <button onclick="clearOTPInputs()">Clear OTP</button>
            </div>

            <button type="button" class="btn btn-primary" onclick="verifyOTP()" id="verifyOtpBtn">X√°c Nh·∫≠n OTP</button>
            <button type="button" class="btn btn-secondary" onclick="backToStep1()">Quay l·∫°i</button>
        </div>

        <!-- Step 3: New Password -->
        <div class="form-step" id="step3Form">
            <div class="message success">
                ‚úÖ OTP x√°c th·ª±c th√†nh c√¥ng! Vui l√≤ng ƒë·∫∑t m·∫≠t kh·∫©u m·ªõi.
            </div>

            <div class="form-group">
                <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
                <input type="password" id="newPassword" class="form-control" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi" oninput="checkPasswordStrength()" required>
                <div class="password-strength" id="passwordStrength">
                    <div class="password-strength-bar"></div>
                </div>
                <div class="password-requirements" id="passwordRequirements">
                    M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±, bao g·ªìm ch·ªØ hoa, ch·ªØ th∆∞·ªùng v√† s·ªë
                </div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                <input type="password" id="confirmPassword" class="form-control" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" oninput="checkPasswordMatch()" required>
                <div class="password-requirements" id="passwordMatchMessage"></div>
            </div>

            <button type="button" class="btn btn-primary" onclick="resetPassword()" id="resetPasswordBtn">ƒê·∫∑t L·∫°i M·∫≠t Kh·∫©u</button>
            <button type="button" class="btn btn-secondary" onclick="backToStep2()">Quay l·∫°i</button>
        </div>
    </div>

    <script>
        // ========== C·∫§U H√åNH BACKEND ==========
        const API_BASE_URL = 'http://localhost:8080/users';
        let userEmail = '';
        let otpTimer;
        let timeLeft = 300; // 5 minutes in seconds

        // H√†m ki·ªÉm tra k·∫øt n·ªëi API
        async function testAPI() {
            console.log('üîç Testing API connection...');
            const statusElement = document.getElementById('apiStatus');
            
            try {
                const response = await fetch(`${API_BASE_URL}/forgot-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: 'test@example.com' })
                });
                
                statusElement.style.display = 'block';
                statusElement.textContent = '‚úÖ ƒê√£ k·∫øt n·ªëi ƒë·∫øn server backend';
                statusElement.className = 'api-status connected';
                
                console.log('‚úÖ API Connection Test: PASSED - Status:', response.status);
                return { success: true, status: response.status };
            } catch (error) {
                statusElement.style.display = 'block';
                statusElement.textContent = '‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra: 1) Server c√≥ ƒëang ch·∫°y? 2) Port 8080?';
                statusElement.className = 'api-status disconnected';
                
                console.error('‚ùå API Connection Test: FAILED -', error);
                return { success: false, error: error.message };
            }
        }

        // H√†m g·ªçi API
        async function callAPI(endpoint, data) {
            console.log(`üì§ Calling API: ${API_BASE_URL}${endpoint}`, data);
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                console.log(`üì• API Response Status: ${response.status} for ${endpoint}`);
                
                let result;
                try {
                    result = await response.json();
                } catch {
                    const text = await response.text();
                    result = { message: text };
                }
                
                console.log(`üì• API Response Data:`, result);
                
                return { 
                    success: response.ok, 
                    data: result,
                    status: response.status 
                };
            } catch (error) {
                console.error(`‚ùå API call failed for ${endpoint}:`, error);
                return { 
                    success: false, 
                    error: 'L·ªói k·∫øt n·ªëi ƒë·∫øn server',
                    data: { message: 'L·ªói k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.' }
                };
            }
        }

        // Show message function
        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('messageContainer');
            const messageClass = type === 'error' ? 'error' : 
                                type === 'success' ? 'success' : 'info';
            
            messageContainer.innerHTML = `
                <div class="message ${messageClass}">
                    ${message}
                </div>
            `;
            
            // Auto remove success/info messages after 5 seconds
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    if (messageContainer.innerHTML.includes(message)) {
                        messageContainer.innerHTML = '';
                    }
                }, 5000);
            }
        }

        // Move between steps
        function goToStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.form-step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Remove active class from all steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            
            // Show current step and mark previous steps as completed
            for (let i = 1; i <= stepNumber; i++) {
                if (i === stepNumber) {
                    document.getElementById(`step${i}`).classList.add('active');
                    setTimeout(() => {
                        document.getElementById(`step${i}Form`).classList.add('active');
                    }, 100);
                } else {
                    document.getElementById(`step${i}`).classList.add('completed');
                }
            }
        }

        // Step 1: Send OTP - G·ªåI API TH·∫¨T
        async function sendOTP() {
            const email = document.getElementById('email').value.trim();
            
            if (!email) {
                showMessage('Vui l√≤ng nh·∫≠p email c·ªßa b·∫°n', 'error');
                return;
            }
            
            if (!isValidEmail(email)) {
                showMessage('Email kh√¥ng h·ª£p l·ªá', 'error');
                return;
            }
            
            userEmail = email;
            
            // Disable button v√† hi·ªÉn th·ªã loading
            const sendButton = document.getElementById('sendOtpBtn');
            const originalText = sendButton.textContent;
            sendButton.textContent = 'üîÑ ƒêang g·ª≠i...';
            sendButton.disabled = true;
            
            showMessage('üîÑ ƒêang g·ª≠i m√£ OTP...', 'info');
            
            try {
                const result = await callAPI('/forgot-password', { email: email });
                
                if (result.success) {
                    showMessage('‚úÖ N·∫øu email t·ªìn t·∫°i, m√£ OTP s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n! Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞ V√Ä console backend.', 'success');
                    document.getElementById('emailDisplay').textContent = email;
                    startOTPTimer();
                    goToStep(2);
                    
                    console.log('=== H∆Ø·ªöNG D·∫™N ===');
                    console.log('1. Ki·ªÉm tra console Spring Boot (n∆°i ch·∫°y ·ª©ng d·ª•ng Java)');
                    console.log('2. T√¨m m√£ OTP trong log');
                    console.log('3. S·ª≠ d·ª•ng m√£ OTP ƒë√≥ ƒë·ªÉ nh·∫≠p v√†o form');
                    console.log('================');
                    
                } else {
                    showMessage(`‚ùå ${result.data?.message || 'L·ªói khi g·ª≠i OTP. Vui l√≤ng th·ª≠ l·∫°i.'}`, 'error');
                }
            } catch (error) {
                showMessage('‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra m·∫°ng v√† th·ª≠ l·∫°i.', 'error');
            } finally {
                // Restore button
                sendButton.textContent = originalText;
                sendButton.disabled = false;
            }
        }

        // Step 2: Verify OTP - G·ªåI API TH·∫¨T
        async function verifyOTP() {
            const otpCode = getOTPCode();
            
            if (otpCode.length !== 6) {
                showMessage('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß 6 ch·ªØ s·ªë OTP', 'error');
                return;
            }
            
            if (!/^\d{6}$/.test(otpCode)) {
                showMessage('M√£ OTP ph·∫£i l√† 6 ch·ªØ s·ªë', 'error');
                return;
            }
            
            // Disable button v√† hi·ªÉn th·ªã loading
            const verifyButton = document.getElementById('verifyOtpBtn');
            const originalText = verifyButton.textContent;
            verifyButton.textContent = 'üîç ƒêang x√°c th·ª±c...';
            verifyButton.disabled = true;
            
            showMessage('üîç ƒêang x√°c th·ª±c OTP...', 'info');
            
            try {
                const result = await callAPI('/verify-otp', {
                    email: userEmail,
                    otp: otpCode
                });
                
                if (result.success) {
                    showMessage('‚úÖ OTP x√°c th·ª±c th√†nh c√¥ng!', 'success');
                    clearInterval(otpTimer);
                    setTimeout(() => goToStep(3), 1000);
                } else {
                    showMessage(`‚ùå ${result.data?.message || 'OTP kh√¥ng ch√≠nh x√°c ho·∫∑c ƒë√£ h·∫øt h·∫°n'}`, 'error');
                    clearOTPInputs();
                }
            } catch (error) {
                showMessage('‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            } finally {
                // Restore button
                verifyButton.textContent = originalText;
                verifyButton.disabled = false;
            }
        }

        // Step 3: Reset Password - G·ªåI API TH·∫¨T
        async function resetPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const otpCode = getOTPCode();
            
            // Validation
            if (!newPassword || !confirmPassword) {
                showMessage('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß m·∫≠t kh·∫©u', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showMessage('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showMessage('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±', 'error');
                return;
            }
            
            // Disable button v√† hi·ªÉn th·ªã loading
            const resetButton = document.getElementById('resetPasswordBtn');
            const originalText = resetButton.textContent;
            resetButton.textContent = 'üîÑ ƒêang x·ª≠ l√Ω...';
            resetButton.disabled = true;
            
            showMessage('üîÑ ƒêang ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u...', 'info');
            
            try {
                const result = await callAPI('/reset-password', {
                    email: userEmail,
                    otp: otpCode,
                    newPassword: newPassword
                });
                
                if (result.success) {
                    showMessage('‚úÖ ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...', 'success');
                    
                    // Redirect to login page after 2 seconds
                    setTimeout(() => {
                        window.location.href = 'login.html?message=password_reset_success';
                    }, 2000);
                } else {
                    showMessage(`‚ùå ${result.data?.message || 'L·ªói khi ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u. Vui l√≤ng th·ª≠ l·∫°i.'}`, 'error');
                }
            } catch (error) {
                showMessage('‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            } finally {
                // Restore button
                resetButton.textContent = originalText;
                resetButton.disabled = false;
            }
        }

        // OTP Input Handling Functions
        function handleOtpInput(current) {
            const index = parseInt(current.getAttribute('data-index'));
            const value = current.value;
            
            // Only allow numbers and ensure it's a single digit
            if (value && !/^\d$/.test(value)) {
                current.value = '';
                return;
            }
            
            // Update visual state
            if (value) {
                current.classList.add('filled');
                
                // Auto-focus next input if available
                if (index < 5) {
                    const nextInput = document.querySelector(`.otp-input[data-index="${index + 1}"]`);
                    if (nextInput) {
                        nextInput.focus();
                    }
                }
            } else {
                current.classList.remove('filled');
            }
        }

        function handleOtpKeydown(current, event) {
            const index = parseInt(current.getAttribute('data-index'));
            const key = event.key;
            
            // Allow only numbers
            if (!/^\d$/.test(key) && 
                !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'].includes(key)) {
                event.preventDefault();
                return;
            }
            
            // Handle Backspace
            if (key === 'Backspace') {
                if (current.value === '' && index > 0) {
                    // Move to previous input and clear it
                    const prevInput = document.querySelector(`.otp-input[data-index="${index - 1}"]`);
                    if (prevInput) {
                        prevInput.focus();
                        prevInput.value = '';
                        prevInput.classList.remove('filled');
                    }
                } else {
                    // Clear current input but stay there
                    current.value = '';
                    current.classList.remove('filled');
                }
                event.preventDefault();
            }
            
            // Handle Arrow keys for navigation
            else if (key === 'ArrowLeft' && index > 0) {
                const prevInput = document.querySelector(`.otp-input[data-index="${index - 1}"]`);
                if (prevInput) prevInput.focus();
                event.preventDefault();
            }
            else if (key === 'ArrowRight' && index < 5) {
                const nextInput = document.querySelector(`.otp-input[data-index="${index + 1}"]`);
                if (nextInput) nextInput.focus();
                event.preventDefault();
            }
            
            // Handle number input
            else if (/^\d$/.test(key)) {
                current.value = key;
                current.classList.add('filled');
                
                // Auto-move to next input
                if (index < 5) {
                    const nextInput = document.querySelector(`.otp-input[data-index="${index + 1}"]`);
                    if (nextInput) {
                        setTimeout(() => nextInput.focus(), 10);
                    }
                }
                event.preventDefault();
            }
        }

        function getOTPCode() {
            const otpInputs = document.querySelectorAll('.otp-input');
            let otpCode = '';
            otpInputs.forEach(input => {
                otpCode += input.value;
            });
            return otpCode;
        }

        function clearOTPInputs() {
            const otpInputs = document.querySelectorAll('.otp-input');
            otpInputs.forEach(input => {
                input.value = '';
                input.classList.remove('filled');
            });
            // Focus on first input
            if (otpInputs[0]) {
                otpInputs[0].focus();
            }
        }

        // Timer Functions
        function startOTPTimer() {
            timeLeft = 300; // Reset to 5 minutes
            updateTimerDisplay();
            
            clearInterval(otpTimer);
            otpTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(otpTimer);
                    const timerElement = document.getElementById('otpTimer');
                    if (timerElement) {
                        timerElement.classList.add('expired');
                    }
                    const resendLink = document.getElementById('resendLink');
                    if (resendLink) {
                        resendLink.classList.remove('disabled');
                    }
                }
            }, 1000);
            
            const resendLink = document.getElementById('resendLink');
            if (resendLink) {
                resendLink.classList.add('disabled');
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const countdownElement = document.getElementById('countdown');
            if (countdownElement) {
                countdownElement.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Resend OTP
        async function resendOTP() {
            const resendLink = document.getElementById('resendLink');
            if (resendLink.classList.contains('disabled')) {
                return;
            }
            
            // Disable resend v√† hi·ªÉn th·ªã loading
            resendLink.classList.add('disabled', 'loading');
            const originalText = resendLink.textContent;
            resendLink.textContent = 'üîÑ ƒêang g·ª≠i...';
            
            showMessage('üîÑ ƒêang g·ª≠i l·∫°i m√£ OTP...', 'info');
            
            try {
                const result = await callAPI('/forgot-password', { email: userEmail });
                
                if (result.success) {
                    showMessage('‚úÖ ƒê√£ g·ª≠i l·∫°i m√£ OTP! Vui l√≤ng ki·ªÉm tra email V√Ä console backend.', 'success');
                    startOTPTimer();
                    clearOTPInputs();
                } else {
                    showMessage(`‚ùå ${result.data?.message || 'L·ªói khi g·ª≠i l·∫°i OTP'}`, 'error');
                    resendLink.classList.remove('disabled');
                }
            } catch (error) {
                showMessage('‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                resendLink.classList.remove('disabled');
            } finally {
                // Restore resend link
                resendLink.classList.remove('loading');
                resendLink.textContent = originalText;
            }
        }

        // Password Strength Check
        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthBar = document.getElementById('passwordStrength');
            const requirements = document.getElementById('passwordRequirements');
            
            if (!strengthBar || !requirements) return;
            
            let strength = 0;
            let feedback = [];
            
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            // Update strength bar
            strengthBar.className = 'password-strength';
            if (strength <= 2) {
                strengthBar.classList.add('weak');
                feedback.push('M·∫≠t kh·∫©u y·∫øu');
            } else if (strength <= 4) {
                strengthBar.classList.add('medium');
                feedback.push('M·∫≠t kh·∫©u trung b√¨nh');
            } else {
                strengthBar.classList.add('strong');
                feedback.push('M·∫≠t kh·∫©u m·∫°nh');
            }
            
            // Update requirements text
            if (password.length > 0) {
                requirements.textContent = feedback.join(' ‚Ä¢ ');
            } else {
                requirements.textContent = 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±, bao g·ªìm ch·ªØ hoa, ch·ªØ th∆∞·ªùng v√† s·ªë';
            }
        }

        function checkPasswordMatch() {
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageElement = document.getElementById('passwordMatchMessage');
            
            if (!messageElement) return;
            
            if (confirmPassword.length === 0) {
                messageElement.textContent = '';
                return;
            }
            
            if (password === confirmPassword) {
                messageElement.textContent = '‚úì M·∫≠t kh·∫©u kh·ªõp';
                messageElement.style.color = '#28a745';
            } else {
                messageElement.textContent = '‚úó M·∫≠t kh·∫©u kh√¥ng kh·ªõp';
                messageElement.style.color = '#dc3545';
            }
        }

        // Navigation Functions
        function backToStep1() {
            goToStep(1);
            clearInterval(otpTimer);
        }

        function backToStep2() {
            goToStep(2);
            startOTPTimer();
        }

        // Utility Functions
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Forgot Password Page Loaded - BACKEND MODE');
            
            // Test API connection on load
            testAPI().then(result => {
                if (result.success) {
                    console.log('‚úÖ Backend connection established');
                } else {
                    console.log('‚ùå Backend connection failed');
                }
            });
            
            // Focus email input on page load
            const emailInput = document.getElementById('email');
            if (emailInput) {
                emailInput.focus();
            }
            
            // Add Enter key support
            if (emailInput) {
                emailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendOTP();
                    }
                });
            }
            
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        resetPassword();
                    }
                });
            }

            // Add paste support for OTP
            const otpInputs = document.querySelectorAll('.otp-input');
            if (otpInputs.length > 0) {
                otpInputs[0].addEventListener('paste', function(e) {
                    e.preventDefault();
                    const pasteData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);
                    const digits = pasteData.split('');
                    
                    digits.forEach((digit, index) => {
                        if (otpInputs[index]) {
                            otpInputs[index].value = digit;
                            otpInputs[index].classList.add('filled');
                        }
                    });
                    
                    // Focus the next empty input or the last one
                    const nextEmptyIndex = digits.length < 6 ? digits.length : 5;
                    if (otpInputs[nextEmptyIndex]) {
                        otpInputs[nextEmptyIndex].focus();
                    }
                });
            }
        });
    </script>
</body>
</html>