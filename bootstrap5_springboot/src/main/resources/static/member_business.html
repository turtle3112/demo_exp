<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω nh√¢n vi√™n doanh nghi·ªáp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .sidebar {
            background: linear-gradient(180deg, #2c3e50 0%, #3498db 100%);
            color: white;
            height: 100vh;
            position: fixed;
            width: 280px;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            margin: 4px 0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .sidebar .nav-link.active {
            background: rgba(52, 152, 219, 0.3);
            color: white;
            border-left: 4px solid #3498db;
        }
        
        .main-content {
            margin-left: 280px;
            padding: 20px;
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        
        .navbar-custom {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-left: 280px;
        }
        
        .employee-card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .employee-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            border: none;
        }
        
        .admin-row {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar .nav-link span {
                display: none;
            }
            
            .main-content, .navbar-custom {
                margin-left: 70px;
            }
        }
        
        /* Modal t·∫°o nhi·ªÅu t√†i kho·∫£n */
        .multiple-accounts-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: #f8f9fa;
        }
        
        .account-item {
            padding: 5px 10px;
            border-bottom: 1px solid #eee;
        }
        
        .account-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header text-center py-4">
            <h4>üè¢ TaskFlow</h4>
            <p class="mb-0 text-light">Qu·∫£n l√Ω doanh nghi·ªáp</p>
        </div>
        
        <div class="user-info text-center p-3">
            <small class="text-light">Xin ch√†o</small>
            <h6 id="sidebarUsername" class="mb-0"></h6>
        </div>
        
        <nav class="nav flex-column px-3">
            <a class="nav-link" href="project_business.html">
                <i class="fas fa-project-diagram"></i>
                <span>D·ª± √°n doanh nghi·ªáp</span>
            </a>
            <a class="nav-link" href="dashboard_business.html">
                <i class="fas fa-chart-bar"></i>
                <span>Dashboard</span>
            </a>
            <a class="nav-link active" href="member_business.html">
                <i class="fas fa-users"></i>
                <span>Nh√¢n vi√™n</span>
            </a>
            <a class="nav-link" href="document_business.html">
                        <i class="fas fa-file-alt"></i>
                        <span>T√†i li·ªáu</span>
                    </a>
            <a class="nav-link" href="settings_business.html">
                <i class="fas fa-cog"></i>
                <span>Thi·∫øt l·∫≠p</span>
            </a>
        </nav>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom px-4">
        <div class="container-fluid">
            <span class="navbar-brand fw-bold" id="currentUsername"></span>
            
            <div class="ms-auto d-flex align-items-center gap-3">
                <!-- TH√äM N√öT T·∫†O NHI·ªÄU T√ÄI KHO·∫¢N -->
                <button id="btnCreateMultiple" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createMultipleEmployeesModal">
                    <i class="fas fa-users"></i> T·∫°o nhi·ªÅu t√†i kho·∫£n
                </button>
                <button id="btnCreateEmployee" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createEmployeeModal">
                    <i class="fas fa-user-plus"></i> T·∫°o t√†i kho·∫£n nh√¢n vi√™n
                </button>
                <button onclick="window.location.href = 'login.html'" class="btn btn-outline-secondary">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container-fluid">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="fw-bold">üë• Qu·∫£n l√Ω nh√¢n vi√™n</h3>
                    <p class="text-muted">Qu·∫£n l√Ω t√†i kho·∫£n nh√¢n vi√™n trong doanh nghi·ªáp c·ªßa b·∫°n</p>
                </div>
                <div class="d-flex gap-2">
                    <div class="input-group" style="width: 300px;">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="searchInput" class="form-control" placeholder="T√¨m ki·∫øm nh√¢n vi√™n...">
                    </div>
                </div>
            </div>

            <!-- Statistics - Ch·ªâ gi·ªØ T·ªïng nh√¢n vi√™n -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="totalEmployees">0</h4>
                                    <p class="mb-0">T·ªïng nh√¢n vi√™n</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Employees List -->
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Danh s√°ch nh√¢n vi√™n</h5>
                    <div>
                        <!-- TH√äM N√öT T·∫†O NHI·ªÄU T√ÄI KHO·∫¢N TRONG CARD HEADER -->
                        <button class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#createMultipleEmployeesModal">
                            <i class="fas fa-users"></i> T·∫°o nhi·ªÅu
                        </button>
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#createEmployeeModal">
                            <i class="fas fa-plus"></i> Th√™m nh√¢n vi√™n
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>T√†i kho·∫£n</th>
                                    <th>H·ªç t√™n</th>
                                    <th>Email</th>
                                    <th>M√£ nh√¢n vi√™n</th>
                                    <th>Ng√†y t·∫°o</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="employeesTableBody">
                                <!-- Employees will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-5" style="display: none;">
                        <div class="empty-icon mb-4">
                            <i class="fas fa-users fa-4x text-muted"></i>
                        </div>
                        <h4 class="text-muted">Ch∆∞a c√≥ nh√¢n vi√™n n√†o</h4>
                        <p class="text-muted mb-4">T·∫°o t√†i kho·∫£n nh√¢n vi√™n ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω</p>
                        <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#createEmployeeModal">
                            <i class="fas fa-user-plus"></i> T·∫°o nh√¢n vi√™n ƒë·∫ßu ti√™n
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal t·∫°o nh√¢n vi√™n (T·ª™NG T√ÄI KHO·∫¢N) -->
    <div class="modal fade" id="createEmployeeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-user-plus"></i> T·∫°o t√†i kho·∫£n nh√¢n vi√™n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">T√™n ƒëƒÉng nh·∫≠p *</label>
                        <input type="text" class="form-control" id="employeeUsername" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M·∫≠t kh·∫©u *</label>
                        <input type="password" class="form-control" id="employeePassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">H·ªç v√† t√™n *</label>
                        <input type="text" class="form-control" id="employeeFullName" placeholder="Nh·∫≠p h·ªç t√™n ƒë·∫ßy ƒë·ªß" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" id="employeeEmail" placeholder="email@congty.com" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√£ nh√¢n vi√™n</label>
                        <input type="text" class="form-control" id="employeeId" placeholder="NV001 (t√πy ch·ªçn)">
                    </div>
                    <div class="alert alert-info">
                        <small>
                            <i class="fas fa-info-circle"></i> 
                            T√†i kho·∫£n nh√¢n vi√™n s·∫Ω ƒë∆∞·ª£c t·∫°o v·ªõi quy·ªÅn EMPLOYEE v√† ch·ªâ c√≥ th·ªÉ ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng doanh nghi·ªáp
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-success" id="btnCreateEmployeeSubmit">
                        <i class="fas fa-save"></i> T·∫°o t√†i kho·∫£n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal t·∫°o NHI·ªÄU nh√¢n vi√™n (H√ÄNG LO·∫†T) -->
    <div class="modal fade" id="createMultipleEmployeesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-users-cog"></i> T·∫°o nhi·ªÅu t√†i kho·∫£n nh√¢n vi√™n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">T√™n ƒëƒÉng nh·∫≠p c∆° s·ªü *</label>
                            <input type="text" class="form-control" id="baseUsername" 
                                   placeholder="V√≠ d·ª•: nhanvien" required>
                            <div class="form-text">T√†i kho·∫£n s·∫Ω ƒë∆∞·ª£c ƒë√°nh s·ªë: nhanvien1, nhanvien2, ...</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">S·ªë l∆∞·ª£ng t√†i kho·∫£n *</label>
                            <input type="number" class="form-control" id="accountCount" 
                                   min="1" max="50" value="1" required>
                            <div class="form-text">T·ªëi ƒëa 50 t√†i kho·∫£n m·ªói l·∫ßn t·∫°o</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√£ nh√¢n vi√™n (ti·ªÅn t·ªë)</label>
                        <input type="text" class="form-control" id="staffCodePrefix" 
                               placeholder="V√≠ d·ª•: NV">
                        <div class="form-text">M√£ nh√¢n vi√™n s·∫Ω ƒë∆∞·ª£c ƒë√°nh s·ªë: NV001, NV002, ...</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Domain email</label>
                        <input type="text" class="form-control" id="emailDomain" 
                               placeholder="company.com" value="company.com">
                        <div class="form-text">Email s·∫Ω c√≥ d·∫°ng: username@domain</div>
                    </div>
                    <div class="alert alert-warning">
                        <small>
                            <i class="fas fa-info-circle"></i> 
                            <strong>L∆∞u √Ω:</strong><br>
                            ‚Ä¢ M·∫≠t kh·∫©u m·∫∑c ƒë·ªãnh s·∫Ω l√† email c·ªßa t√†i kho·∫£n<br>
                            ‚Ä¢ T√™n ƒë·∫ßy ƒë·ªß m·∫∑c ƒë·ªãnh: Nh√¢n vi√™n 1, Nh√¢n vi√™n 2, ...<br>
                            ‚Ä¢ Email s·∫Ω c√≥ d·∫°ng: [username]@[domain]
                        </small>
                    </div>
                    <!-- K·∫øt qu·∫£ t·∫°o t√†i kho·∫£n -->
                    <div class="alert alert-success" id="batchResult" style="display:none;">
                        <h6><i class="fas fa-check-circle"></i> K·∫øt qu·∫£:</h6>
                        <div id="createdAccountsList" class="multiple-accounts-list"></div>
                        <p class="mt-2 mb-0"><small><strong>M·∫≠t kh·∫©u m·∫∑c ƒë·ªãnh:</strong> Email c·ªßa t√†i kho·∫£n (nh√¢n vi√™n n√™n ƒë·ªïi sau khi ƒëƒÉng nh·∫≠p)</small></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" id="btnCreateMultipleEmployees">
                        <i class="fas fa-bolt"></i> T·∫°o h√†ng lo·∫°t
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ch·ªânh s·ª≠a nh√¢n vi√™n -->
    <div class="modal fade" id="editEmployeeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> Ch·ªânh s·ª≠a nh√¢n vi√™n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editEmployeeId">
                    <div class="mb-3">
                        <label class="form-label">T√™n ƒëƒÉng nh·∫≠p</label>
                        <input type="text" class="form-control" id="editEmployeeUsername" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">H·ªç v√† t√™n *</label>
                        <input type="text" class="form-control" id="editEmployeeFullName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" id="editEmployeeEmail" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√£ nh√¢n vi√™n</label>
                        <input type="text" class="form-control" id="editEmployeeCode">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-warning text-white" id="btnSubmitEditEmployee">
                        <i class="fas fa-save"></i> C·∫≠p nh·∫≠t
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Th√™m bi·∫øn API_BASE_URL
        const API_BASE_URL = "http://localhost:8080";

        class EmployeeBusiness {
            constructor() {
                this.currentUser = JSON.parse(localStorage.getItem('user'));
                this.init();
            }

            async init() {
                console.log('=== DEBUG START ===');
                console.log('User Data:', this.currentUser);
                
                if (!this.currentUser) {
                    alert('Vui l√≤ng ƒëƒÉng nh·∫≠p');
                    window.location.href = 'login.html';
                    return;
                }

                // Ki·ªÉm tra quy·ªÅn ENTERPRISE ADMIN
                if (this.currentUser.accountType !== 'ENTERPRISE' || this.currentUser.role !== 'ADMIN') {
                    console.log('Permission denied - Account type:', this.currentUser.accountType, 'Role:', this.currentUser.role);
                    alert('Ch·ªâ Admin doanh nghi·ªáp m·ªõi c√≥ quy·ªÅn truy c·∫≠p trang n√†y');
                    window.location.href = 'dashboard_business.html';
                    return;
                }

                this.organizationId = this.currentUser.organizationId || 
                                     (this.currentUser.organization ? this.currentUser.organization.id : null);
                console.log('Organization ID:', this.organizationId);
                console.log('Current User Object:', this.currentUser);
                console.log('Available keys:', Object.keys(this.currentUser));
                // Hi·ªÉn th·ªã th√¥ng tin user
                document.getElementById('sidebarUsername').textContent = this.currentUser.fullName;
                document.getElementById('currentUsername').textContent = this.currentUser.fullName;

                console.log('=== DEBUG END ===');
                
                await this.loadEmployees();
                this.setupEventListeners();
            }

            async loadEmployees() {
                try {
                    console.log('Loading employees for organization:', this.organizationId);
                    console.log('Token:', localStorage.getItem('token'));
                    
                    // ‚úÖ G·ªåI API TH·∫¨T - Th√™m error handling
                    const response = await fetch(`/api/organizations/${this.organizationId}/employees`, {
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('token'),
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('Response status:', response.status);
                    
                    if (response.status === 401) {
                        alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }
                    
                    const employees = await response.json();
                    console.log('Real API response:', employees);
                    this.renderEmployees(employees);
                    this.updateStatistics(employees);
                    
                } catch (error) {
                    console.error('Error loading employees:', error);
                    
                    // ‚ùå T·∫†M TH·ªúI: Fallback to mock data ƒë·ªÉ test UI
                    console.log('Using mock data for UI testing');
                    const mockEmployees = [
                        {
                            id: this.currentUser.id,
                            username: this.currentUser.username,
                            fullName: this.currentUser.fullName,
                            email: this.currentUser.email,
                            employeeId: "ADMIN001",
                            createdAt: new Date().toISOString(),
                            admin: true
                        },
                        {
                            id: 13,
                            username: "nhanvien1",
                            fullName: "Nguy·ªÖn VƒÉn A",
                            email: "nva@company.com",
                            employeeId: "NV001",
                            createdAt: "2024-01-15T00:00:00",
                            admin: false
                        },
                        {
                            id: 14,
                            username: "nhanvien2",
                            fullName: "Tr·∫ßn Th·ªã B", 
                            email: "ttb@company.com",
                            employeeId: "NV002",
                            createdAt: "2024-02-20T00:00:00",
                            admin: false
                        }
                    ];
                    this.renderEmployees(mockEmployees);
                    this.updateStatistics(mockEmployees);
                }
            }

            renderEmployees(employees) {
                const tbody = document.getElementById('employeesTableBody');
                const emptyState = document.getElementById('emptyState');

                if (!employees || employees.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }

                emptyState.style.display = 'none';
                
                tbody.innerHTML = employees.map(emp => {
                    const isCurrentAdmin = emp.id === this.currentUser.id;
                    const rowClass = isCurrentAdmin ? 'admin-row' : '';
                    
                    return `
                        <tr class="${rowClass}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" 
                                         style="width: 35px; height: 35px;">
                                        <span class="text-white fw-bold small">${emp.username?.charAt(0) || 'U'}</span>
                                    </div>
                                    <div>
                                        <strong>${emp.username}</strong>
                                        ${isCurrentAdmin ? '<br><small class="text-warning"><i class="fas fa-crown"></i> Qu·∫£n tr·ªã</small>' : ''}
                                    </div>
                                </div>
                            </td>
                            <td>
                                ${emp.fullName}
                                ${isCurrentAdmin ? '<br><small class="text-muted">(T√†i kho·∫£n c·ªßa b·∫°n)</small>' : ''}
                            </td>
                            <td>${emp.email}</td>
                            <td>${emp.employeeId || '-'}</td>
                            <td>${new Date(emp.createdAt).toLocaleDateString('vi-VN')}</td>
                            <td>
                                ${!isCurrentAdmin ? `
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary edit-employee" 
                                            data-employee-id="${emp.id}"
                                            data-username="${emp.username}"
                                            data-fullname="${emp.fullName}"
                                            data-email="${emp.email}"
                                            data-employee-id="${emp.employeeId}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger delete-employee" data-employee-id="${emp.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                ` : '<span class="text-muted">Kh√¥ng th·ªÉ ch·ªânh s·ª≠a</span>'}
                            </td>
                        </tr>
                    `;
                }).join('');

                // Add event listeners ch·ªâ cho nh√¢n vi√™n (kh√¥ng ph·∫£i admin)
                document.querySelectorAll('.edit-employee').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.openEditModal(e.target.closest('.edit-employee'));
                    });
                });

                document.querySelectorAll('.delete-employee').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const employeeId = e.target.closest('.delete-employee').getAttribute('data-employee-id');
                        this.deleteEmployee(employeeId);
                    });
                });
            }

            updateStatistics(employees) {
                // Ch·ªâ hi·ªÉn th·ªã t·ªïng s·ªë nh√¢n vi√™n (bao g·ªìm c·∫£ admin)
                document.getElementById('totalEmployees').textContent = employees.length;
            }

            showEmptyState() {
                document.getElementById('employeesTableBody').innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
            }

            setupEventListeners() {
                // Create single employee
                document.getElementById('btnCreateEmployeeSubmit').addEventListener('click', () => {
                    this.createEmployee();
                });

                // Create multiple employees
                document.getElementById('btnCreateMultipleEmployees').addEventListener('click', () => {
                    this.createMultipleEmployees();
                });

                // Edit employee
                document.getElementById('btnSubmitEditEmployee').addEventListener('click', () => {
                    this.updateEmployee();
                });

                // Search functionality
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.searchEmployees(e.target.value);
                });

                // Reset modal khi ƒë√≥ng
                const multipleModal = document.getElementById('createMultipleEmployeesModal');
                if (multipleModal) {
                    multipleModal.addEventListener('hidden.bs.modal', () => {
                        document.getElementById('baseUsername').value = '';
                        document.getElementById('accountCount').value = 1;
                        document.getElementById('staffCodePrefix').value = '';
                        document.getElementById('emailDomain').value = 'company.com';
                        document.getElementById('batchResult').style.display = 'none';
                    });
                }
            }

            async createEmployee() {
                const username = document.getElementById('employeeUsername').value;
                const password = document.getElementById('employeePassword').value;
                const fullName = document.getElementById('employeeFullName').value;
                const email = document.getElementById('employeeEmail').value;
                const employeeId = document.getElementById('employeeId').value;

                if (!username || !password || !fullName || !email) {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
                    return;
                }

                try {
                    // ‚úÖ G·ªåI API TH·∫¨T
                    const response = await fetch(`/api/organizations/${this.organizationId}/employees`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('token')
                        },
                        body: JSON.stringify({
                            username,
                            password,
                            fullName,
                            email,
                            employeeId
                        })
                    });

                    if (response.ok) {
                        alert('T·∫°o t√†i kho·∫£n nh√¢n vi√™n th√†nh c√¥ng!');
                        $('#createEmployeeModal').modal('hide');
                        
                        // Reset form
                        document.getElementById('employeeUsername').value = '';
                        document.getElementById('employeePassword').value = '';
                        document.getElementById('employeeFullName').value = '';
                        document.getElementById('employeeEmail').value = '';
                        document.getElementById('employeeId').value = '';
                        
                        // ‚úÖ Load l·∫°i danh s√°ch T·ª™ SERVER
                        await this.loadEmployees();
                    } else {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to create employee');
                    }

                } catch (error) {
                    console.error('Error creating employee:', error);
                    alert('L·ªói khi t·∫°o t√†i kho·∫£n nh√¢n vi√™n: ' + error.message);
                }
            }

            // PH∆Ø∆†NG TH·ª®C M·ªöI: T·∫°o nhi·ªÅu t√†i kho·∫£n nh√¢n vi√™n
            async createMultipleEmployees() {
                const baseUsername = document.getElementById('baseUsername').value.trim();
                const accountCount = parseInt(document.getElementById('accountCount').value);
                const staffCodePrefix = document.getElementById('staffCodePrefix').value.trim();
                const emailDomain = document.getElementById('emailDomain').value.trim() || 'company.com';

                if (!baseUsername || !accountCount) {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
                    return;
                }

                if (accountCount > 50) {
                    alert('S·ªë l∆∞·ª£ng t√†i kho·∫£n t·ªëi ƒëa l√† 50');
                    return;
                }

                try {
                    // Hi·ªÉn th·ªã loading
                    const submitBtn = document.getElementById('btnCreateMultipleEmployees');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o...';
                    submitBtn.disabled = true;

                    // S·ª≠ d·ª•ng v√≤ng l·∫∑p ƒë·ªÉ t·∫°o t·ª´ng t√†i kho·∫£n
                    const createdAccounts = [];
                    const failedAccounts = [];

                    for (let i = 1; i <= accountCount; i++) {
                        try {
                            // T·∫°o username: baseUsername + s·ªë th·ª© t·ª±
                            const username = `${baseUsername}${i}`;
                            
                            // T·∫°o email d·ª±a tr√™n username v√† domain
                            const email = `${username}@${emailDomain}`;
                            
                            // T·∫°o employeeId n·∫øu c√≥ prefix
                            const employeeId = staffCodePrefix ? 
                                `${staffCodePrefix}${i.toString().padStart(3, '0')}` : 
                                `NV${i.toString().padStart(3, '0')}`;
                            
                            // T√™n ƒë·∫ßy ƒë·ªß m·∫∑c ƒë·ªãnh
                            const fullName = `Nh√¢n vi√™n ${i}`;
                            
                            // M·∫≠t kh·∫©u l√† email (theo y√™u c·∫ßu)
                            const password = email;

                            console.log(`ƒêang t·∫°o t√†i kho·∫£n ${i}/${accountCount}:`, { 
                                username, email, employeeId 
                            });

                            // G·ªçi API t·∫°o t·ª´ng t√†i kho·∫£n
                            const response = await fetch(`/api/organizations/${this.organizationId}/employees`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                                },
                                body: JSON.stringify({
                                    username: username,
                                    password: password, // M·∫≠t kh·∫©u l√† email
                                    fullName: fullName,
                                    email: email,
                                    employeeId: employeeId
                                })
                            });

                            if (response.ok) {
                                createdAccounts.push({
                                    username: username,
                                    password: password, // M·∫≠t kh·∫©u (email)
                                    email: email,
                                    employeeId: employeeId
                                });
                                console.log(`‚úÖ ƒê√£ t·∫°o t√†i kho·∫£n ${username}`);
                            } else {
                                const errorText = await response.text();
                                failedAccounts.push({
                                    username: username,
                                    error: errorText || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'
                                });
                                console.error(`‚ùå L·ªói t·∫°o t√†i kho·∫£n ${username}:`, errorText);
                            }
                        } catch (error) {
                            failedAccounts.push({
                                username: `${baseUsername}${i}`,
                                error: error.message
                            });
                            console.error(`‚ùå L·ªói khi t·∫°o t√†i kho·∫£n ${baseUsername}${i}:`, error);
                        }
                    }

                    // Hi·ªÉn th·ªã k·∫øt qu·∫£
                    const resultDiv = document.getElementById('batchResult');
                    const accountsList = document.getElementById('createdAccountsList');
                    
                    if (createdAccounts.length > 0) {
                        accountsList.innerHTML = `
                            <p><strong>‚úÖ ƒê√£ t·∫°o ${createdAccounts.length} t√†i kho·∫£n th√†nh c√¥ng${failedAccounts.length > 0 ? ` (${failedAccounts.length} th·∫•t b·∫°i)` : ''}:</strong></p>
                            <div class="multiple-accounts-list">
                                ${createdAccounts.map(acc => `
                                    <div class="account-item">
                                        <strong>${acc.username}</strong><br>
                                        <small>M·∫≠t kh·∫©u: ${acc.password}</small><br>
                                        <small>Email: ${acc.email}</small><br>
                                        <small>M√£ NV: ${acc.employeeId}</small>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        resultDiv.style.display = 'block';
                        
                        // Cu·ªôn ƒë·∫øn k·∫øt qu·∫£
                        resultDiv.scrollIntoView({ behavior: 'smooth' });
                        
                        // ƒê·ª£i 3 gi√¢y r·ªìi reload danh s√°ch v√† ƒë√≥ng modal
                        setTimeout(async () => {
                            await this.loadEmployees();
                            $('#createMultipleEmployeesModal').modal('hide');
                            // Reset form
                            document.getElementById('baseUsername').value = '';
                            document.getElementById('accountCount').value = 1;
                            document.getElementById('staffCodePrefix').value = '';
                            resultDiv.style.display = 'none';
                        }, 3000);
                        
                    } else {
                        alert(`‚ùå Kh√¥ng th·ªÉ t·∫°o b·∫•t k·ª≥ t√†i kho·∫£n n√†o. Vui l√≤ng ki·ªÉm tra l·∫°i API ho·∫∑c th·ª≠ t·∫°o t·ª´ng t√†i kho·∫£n.`);
                    }

                } catch (error) {
                    console.error("‚ùå L·ªói khi t·∫°o t√†i kho·∫£n h√†ng lo·∫°t:", error);
                    alert("C√≥ l·ªói x·∫£y ra khi t·∫°o t√†i kho·∫£n: " + error.message);
                } finally {
                    // Kh√¥i ph·ª•c n√∫t
                    const submitBtn = document.getElementById('btnCreateMultipleEmployees');
                    if (submitBtn) {
                        submitBtn.innerHTML = '<i class="fas fa-bolt"></i> T·∫°o h√†ng lo·∫°t';
                        submitBtn.disabled = false;
                    }
                }
            }

            openEditModal(button) {
                const employeeId = button.getAttribute('data-employee-id');
                const username = button.getAttribute('data-username');
                const fullName = button.getAttribute('data-fullname');
                const email = button.getAttribute('data-email');
                const empId = button.getAttribute('data-employee-id');

                document.getElementById('editEmployeeId').value = employeeId;
                document.getElementById('editEmployeeUsername').value = username;
                document.getElementById('editEmployeeFullName').value = fullName;
                document.getElementById('editEmployeeEmail').value = email;
                document.getElementById('editEmployeeCode').value = empId || '';

                $('#editEmployeeModal').modal('show');
            }

            async updateEmployee() {
                const employeeId = document.getElementById('editEmployeeId').value;
                const fullName = document.getElementById('editEmployeeFullName').value;
                const email = document.getElementById('editEmployeeEmail').value;
                const empId = document.getElementById('editEmployeeCode').value;

                if (!fullName || !email) {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
                    return;
                }

                try {
                    // G·ªçi API c·∫≠p nh·∫≠t th√¥ng tin nh√¢n vi√™n
                    const response = await fetch(`/api/organizations/${this.organizationId}/employees/${employeeId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('token')
                        },
                        body: JSON.stringify({
                            fullName: fullName,
                            email: email,
                            employeeId: empId
                        })
                    });

                    if (response.ok) {
                        alert('C·∫≠p nh·∫≠t th√¥ng tin nh√¢n vi√™n th√†nh c√¥ng!');
                        $('#editEmployeeModal').modal('hide');
                        await this.loadEmployees();
                    } else {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to update employee');
                    }

                } catch (error) {
                    console.error('Error updating employee:', error);
                    alert('L·ªói khi c·∫≠p nh·∫≠t th√¥ng tin nh√¢n vi√™n: ' + error.message);
                }
            }

            async deleteEmployee(employeeId) {
                if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√¢n vi√™n n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
                    return;
                }

                try {
                    // ‚úÖ G·ªåI API TH·∫¨T
                    const response = await fetch(`/api/organizations/${this.organizationId}/employees/${employeeId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('token'),
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        alert('ƒê√£ x√≥a nh√¢n vi√™n th√†nh c√¥ng!');
                        // ‚úÖ Load l·∫°i danh s√°ch T·ª™ SERVER
                        await this.loadEmployees();
                    } else {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to delete employee');
                    }

                } catch (error) {
                    console.error('Error deleting employee:', error);
                    alert('L·ªói khi x√≥a nh√¢n vi√™n: ' + error.message);
                }
            }

            searchEmployees(query) {
                console.log('Searching employees for:', query);
                // Implement search functionality here
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new EmployeeBusiness();
        });
    </script>
    <script src="js/auth-check.js"></script>
</body>
</html>